// priority: 500
JEIAddedEvents.registerRecipes((event) => {
    event.custom("fast:ender_chest")
            .add({name: 'tarotcards:the_fool', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:the_hanged_man', type: 'item', description: '全属性中有一个属性为负数时获得'})
            .add({name: 'tarotcards:the_lovers', type: 'key', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:the_hero_fishing_rod', type: 'key', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'tarotcards:the_chariot', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:the_high_priestess', type: 'key', description: '副本掉落'})
            .add({name: 'fast:uma_factor_item', type: 'item', description: '抽奖卷赛马娘卡池5%概率获得'})
            .add({name: 'tarotcards:the_devil', type: 'item', description: '合成获得'})
            .add({name: 'tarotcards:strength', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:the_emperor', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'tarotcards:the_empress', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'tarotcards:the_hermit', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'tarotcards:wheel_of_fortune', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'tarotcards:temperance', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:the_tower', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'tarotcards:the_moon', type: 'item', description: '睡觉过且获得足够的钱币后任务获得'})
            .add({name: 'tarotcards:the_sun', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:death', type: 'item', description: '所有怪物都有0.01%概率掉落'})
            .add({name: 'tarotcards:the_magician', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'tarotcards:judgement', type: 'item', description: '血量低于20%时被雷劈获得'})
            .add({name: 'tarotcards:the_star', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:the_world', type: 'key', description: '商店购买或悬赏获得'})
            .add({name: 'fast:shadow_assassin_cloak', type: 'key', description: '商店购买或悬赏获得'})
            .add({name: 'fast:blaze_necklace', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:blaze_scroll', type: 'key', description: '副本掉落'})
            .add({name: 'fast:the_hero_sword', type: 'key', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:magic_shield', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:sword_technique_decisive_strike', type: 'key', description: '商店购买或悬赏获得或副本掉落'})
            .add({name: 'tconstruct:encyclopedia', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:the_hero_staff', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:the_hero_bow', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:the_hero_shield', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:the_hero_card', type: 'item', description: '无法获得'})
            //.add({name: 'fast:sword_technique_fury_charge', type: 'key', description: '副本掉落'})
            .add({name: 'fast:ender_necklace', type: 'key', description: '商店购买或悬赏获得'})
            .add({name: 'fast:magic_quiver', type: 'key', description: '副本掉落'})
            .add({name: 'fast:megumin_magic_staff', type: 'item', description: '商店购买或悬赏获得'})
            // .add({name: 'fast:ball_lightning', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:fireball', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:firebolt', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:icicle', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:magic_missile', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:straight_projectile', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:falling_projectile', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:count', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:delay', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:base_damage', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:damage_up', type: 'key', description: '副本掉落'})
            // .add({name: 'fast:explosion_radius', type: 'key', description: '副本掉落'})
            .add({name: 'fast:iron_ring', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:gold_ring', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:diamond_ring', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:primal_fire', type: 'key', description: '副本掉落'})
            .add({name: 'fast:blaze_shard', type: 'key', description: '副本掉落'})
            .add({name: 'fast:magic_arrow', type: 'key', description: '副本掉落'})
            .add({name: 'fast:charge', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:branch', type: 'key', description: '副本掉落'})
            .add({name: 'fast:wooden_craftsman_hammer', type: 'key', description: '副本掉落'})
            .add({name: 'fast:shadow_dagge', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:frost_staff', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:the_hierophant', type: 'key', description: '副本掉落'})
            .add({name: 'tarotcards:justice', type: 'key', description: '副本掉落'})
            .add({name: 'fast:the_dice_of_fate', type: 'key', description: '副本掉落'})
            .add({name: 'fast:godspeed_wield', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'irons_spellbooks:fire_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:ice_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:lightning_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:holy_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:ender_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:blood_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:evocation_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'irons_spellbooks:nature_upgrade_orb', type: 'item', description: '合成获得'})
            .add({name: 'fast:bule_gem', type: 'key', description: '副本掉落'})
            .add({name: 'fast:str_gem', type: 'item', description: '商店购买'})
            .add({name: 'fast:agi_gem', type: 'item', description: '商店购买'})
            .add({name: 'fast:int_gem', type: 'item', description: '商店购买'})
            .add({name: 'fast:vit_gem', type: 'key', description: '商店购买'})
            .add({name: 'fast:spell_storage_sphere', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:ice_scroll', type: 'key', description: '副本掉落'})
            .add({name: 'fast:iron_craftsman_hammer', type: 'item', description: '浇铸制作获得'})
            .add({name: 'fast:gold_craftsman_hammer', type: 'key', description: '铸模琨压或者副本获得'})
            .add({name: 'fast:diamond_craftsman_hammer', type: 'key', description: '序列组装或者副本获得'})
            .add({name: 'fast:brass_craftsman_hammer', type: 'item', description: '序列组装获得'})
            .add({name: 'fast:netherite_ingot_craftsman_hammer', type: 'key', description: '序列组装或者副本获得'})
            .add({name: 'fast:iron_heart', type: 'item', description: '动力合成器合成获得'})
            .add({name: 'fast:sword_technique_four_strike', type: 'key', description: '副本掉落'})
            .add({name: 'fast:iron_precision_mechanism', type: 'item', description: '精密构件注液获得'})
            .add({name: 'fast:water_precision_mechanism', type: 'item', description: '精密构件注液获得'})
            .add({name: 'fast:rose_quartz_gauntlets', type: 'item', description: '动力合成器合成获得'})
            .add({name: 'touhou_little_maid:fall_protect_bauble', type: 'item', description: '神社合成获得'})
            .add({name: 'fast:ender_scroll', type: 'key', description: '副本获得'})
            .add({name: 'fast:overcharged_mana_flask', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'cataclysm:necklace_of_the_desert', type: 'key', description: '副本获得'})
            .add({name: 'cataclysm:abyssal_sacrifice', type: 'key', description: '副本获得'})
            .add({name: 'cataclysm:burning_ashes', type: 'item', description: '燃魂掉落获得'})
            .add({name: 'cataclysm:flame_eye', type: 'key', description: '副本掉落'})
            .add({name: 'cataclysm:void_eye', type: 'key', description: '副本掉落'})
            .add({name: 'cataclysm:abyss_eye', type: 'key', description: '副本掉落'})
            .add({name: 'cataclysm:mech_eye', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'cataclysm:monstrous_eye', type: 'key', description: '副本掉落'})
            .add({name: 'cataclysm:cursed_eye', type: 'key', description: '副本掉落'})
            .add({name: 'cataclysm:desert_eye', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:ender_pouch', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:lethal_shutter', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:grimoire_of_mana_reaping', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:fire_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:ice_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:nature_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:lightning_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:blood_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:holy_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:ender_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:evocation_magic_shard', type: 'item', description: '战利品宝箱20%概率随机获得一个学派的魔法碎片'})
            .add({name: 'fast:blazing_judgement', type: 'item', description: '岩浆钓鱼时的宝藏获得，概率为5.46%'})
            .add({name: 'fast:riftsong_edge', type: 'key', description: '副本获得'})
            .add({name: 'hmag:fortune_crystal_plus', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'hmag:fortune_crystal', type: 'item', description: '由末影饰品幸运水晶+获得'})
            .add({name: 'fast:ender_brass_hand', type: 'item', description: '序列组装获得'})
            .add({name: 'fast:maid_food_auto_sell_token', type: 'item', description: '商店购买获得'})
            .add({name: 'fast:the_card1', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card2', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card3', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card4', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card5', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card6', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card7', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card8', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card9', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card10', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card11', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:the_card12', type: 'item', description: '抽卡盒获得，所有副本通关都有20%概率获得。具体概率在主线第一章任务查看。'})
            .add({name: 'fast:deepblue_crystal', type: 'item', description: '从购买钥匙的商店购买，开启深蓝之渊后可获得大部分末影饰品'})
            .add({name: 'fast:apprentice_staff', type: 'item', description: '合成获得'})
            .add({name: 'fast:compassionate_heart', type: 'item', description: '商店购买或悬赏获得'})
            .add({name: 'fast:shining_beacon', type: 'item', description: '合成获得'})
            .add({name: 'fast:shimmering_diamond', type: 'item', description: '合成获得'})
            .add({name: 'celestisynth:celestial_core', type: 'key', description: '合成或者副本获得'})
            .add({name: 'fast:ammo_drive', type: 'key', description: '副本掉落'})
            .add({name: 'fast:precision_pouch', type: 'item', description: '合成获得'})
            .add({name: 'fast:thunderbrand_magazine', type: 'item', description: '合成获得'})
            .add({name: 'fast:custom_spell', type: 'key', description: '副本获得'})
            .add({name: 'fast:custom_spell', type: 'key', description: '副本获得', key: 'fast:key35'})
            .add({name: 'fast:custom_spell', type: 'key', description: '副本获得', key: 'fast:key27'})
            .add({name: 'fast:custom_spell', type: 'key', description: '副本获得', key: 'fast:key26'})
            .add({name: 'fast:daedalus_stormbow', type: 'item', description: '宝箱怪25%概率掉落'})
            .add({name: 'minecraft:sugar', type: 'item', description: '商店购买'})
            .add({name: 'create:andesite_alloy', type: 'item', description: '商店购买'})
            .add({name: 'cataclysm:storm_eye', type: 'key', description: '副本掉落'})
            .add({name: 'fast:justice_staff', type: 'item', description: '商店购买'})
            .add({name: 'fast:magic_sword', type: 'item', description: '商店购买'})
            .add({name: 'fast:berserker_bow', type: 'item', description: '商店购买'})
            .add({name: 'fast:sword_soul', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:the_hero_dice', type: 'item', description: '初始赠送或购买获得的兑换物品在任务书兑换'})
            .add({name: 'fast:dirt_platform', type: 'item', description: '商店购买'})
            .add({name: 'minecraft:bedrock', type: 'item', description: '商店购买或搅拌获得'})
            .add({name: 'fast:potential_reverter', type: 'key', description: '所有Boss副本都有10%概率掉落'})
            .add({name: 'fast:blood_pact', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:blood_brand', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:blood_tally', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:blood_vitality', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:blood_oath', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:pot_pot', type: 'item', description: '第二章僵尸召唤者任务获得'})
            .add({name: 'fast:fate_gem_strength', type: 'key', description: '副本10%概率掉落'})
            .add({name: 'fast:fate_gem_intelligence', type: 'key', description: '副本10%概率掉落'})
            .add({name: 'fast:fate_gem_vitality', type: 'key', description: '副本10%概率掉落'})
            .add({name: 'fast:fate_gem_agility', type: 'key', description: '副本10%概率掉落'})
            .add({name: 'fast:sword_technique_flying_sword_guard', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:shadow_chaser', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:soul_pact', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:realm_splitter', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:spirit_surge', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'fast:demon_caller', type: 'key', description: '副本15%概率掉落'})
            .add({name: 'mokels_bossfight_saphyra:nameless_gatekeeper_remembrance', type: 'item', description: '无名守门人掉落'})
            .add({name: 'hmag:evil_crystal', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:soul_powder', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:ender_plasm', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:ancient_stone', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:lightning_particle', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:insomnia_fruit', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:insomnia_sword', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:reinforcing_chain', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:purification_cloth', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:endless_pearl', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:fire_bottle', type: 'key', description: '副本掉落'})
            .add({name: 'hmag:greedy_crystal_plus', type: 'key', description: '副本掉落'})
            .add({name: 'fast:deepblue_shard', type: 'item', description: '深蓝之渊掉落(怪物房，boss房，商店都能获得)'})
            .add({name: 'fast:source_of_venom', type: 'item', description: '商店购买'})
            .add({name: 'fast:justice_shield', type: 'item', description: '商店购买'})
            .add({name: 'fast:treasure_hoarder', type: 'item', description: '商店购买'})
            .add({name: 'fast:treasure_bait', type: 'item', description: '商店购买'})
});

JEIAddedEvents.registerCategories((event) => {
    const guiHelper = event.JEI_HELPERS.guiHelper;
    event.custom("fast:ender_chest", (category) => {
        category.title("整合包物品的获取方式") // 设置分类标题
                .background(guiHelper.createBlankDrawable(100, 70)) // 100x50空白背景
                .icon(guiHelper.createDrawableItemStack(Item.of('fast:the_hero_sword'))) 
                // 验证配方是否属于本分类
                .isRecipeHandled((recipe) => {
                    return global["verifyRecipe"](category.jeiHelpers, recipe);
                })
                // 定义配方输入输出
                .handleLookup((builder, recipe, focuses) => {
                    global["handleLookup"](category.jeiHelpers, builder, recipe, focuses);
                })
                // 自定义渲染逻辑
                .setDrawHandler((recipe, recipeSlotsView, guiGraphics, mouseX, mouseY) => {
                    global["renderPainfulBlocks"](category.jeiHelpers, recipe, recipeSlotsView, guiGraphics, mouseX, mouseY);
                })
    });
});

global["verifyRecipe"] = (jeiHelpers, recipe) => {
    if (!recipe) return false;
    if (!recipe.data) return false;
    if (!recipe.data.type) return false;
    if (!recipe.data.name) return false;
    return !!recipe.data.description; // 必须包含描述字段
}

global["handleLookup"] = (jeiHelpers, builder, recipe, focuses) => {
        let data = recipe.data
        let thisitemId = data.name;
        let keyitem = "minecraft:ender_chest";
        let type = data.type;
        let NewDungonItem = null
        if (type === "key") {
        for (let dungeonName in dungeonConfig) {
        let dungeon = dungeonConfig[dungeonName];
        let rewards = dungeon.reward;
            if (rewards) {
        rewards.forEach((reward) => {
        if (keyitem !== "minecraft:ender_chest") return
            if (reward.item === thisitemId) {
                let keyitemName = dungeon.keyItem;
                keyitem = keyitemName;
            }
        })
    }
    if (data.key) {
    keyitem = data.key
    }
    if (keyitem !== "minecraft:ender_chest") {
                let suffixNumber = keyitem.match(/\d+$/);
                let number = parseInt(suffixNumber[0]);
                NewDungonItem = `fast:instance_pass${number}`;
    break
    }
    };
    }
    switch (type) {
        case "key": // 新增 key 类型处理
        case "item":
        if (keyitem !== "minecraft:ender_chest") {
            builder.addSlot("INPUT", 42, 52)  // 输出槽，位置在 (42, 20)
                   .addItemStack(Item.of(keyitem))
                   .setSlotName("keyinput");
            builder.addInvisibleIngredients("OUTPUT") // 隐藏输出槽
                   .addItemStack(Item.of(keyitem));
            builder.addInvisibleIngredients("INPUT") // 隐藏输入槽
                   .addItemStack(Item.of("minecraft:ender_chest"));
            builder.addInvisibleIngredients("OUTPUT")
                   .addItemStack(Item.of("minecraft:ender_chest"));
            if (NewDungonItem) {
            builder.addInvisibleIngredients("INPUT") // 隐藏输入槽
                   .addItemStack(Item.of(NewDungonItem));
            builder.addInvisibleIngredients("OUTPUT")
                   .addItemStack(Item.of(NewDungonItem));
            }
            } else {
            builder.addInvisibleIngredients("INPUT")
                   .addItemStack(Item.of(keyitem));
            builder.addInvisibleIngredients("OUTPUT")
                   .addItemStack(Item.of(keyitem));
            }
            builder.addSlot("OUTPUT", 42, 32) 
                   .addItemStack(Item.of(thisitemId))
                   .setSlotName("keyoutput");
            builder.addInvisibleIngredients("INPUT") // 隐藏输入槽
                   .addItemStack(Item.of(thisitemId));
            break;
    }
}

global["renderPainfulBlocks"] = (jeiHelpers, recipe, recipeSlotsView, guiGraphics, mouseX, mouseY) => {
    // 使用Minecraft字体绘制描述文本
    guiGraphics.drawWordWrap(
        Client.font, 
        Text.of(recipe.data.description), 
        0, // X起始
        0, // Y起始
        100, // 最大宽度
        0    // 颜色代码
    );
}