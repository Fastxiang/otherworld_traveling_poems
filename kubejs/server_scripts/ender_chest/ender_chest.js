const ItemBonusOnlyMap = {
    'tarotcards:the_fool': 'theFoolPresent',
    'tarotcards:the_hanged_man': 'theHangedManPresent',
    'tarotcards:the_lovers': 'theLoversPresent',
    'tarotcards:the_chariot': 'theChariotPresent',
    'tarotcards:the_high_priestess': 'theHighPriestessPresent',
    'fast:uma_factor_item': 'umaFactorItemPresent',
    'tarotcards:the_devil': 'theDevilPresent',
    'tarotcards:strength': 'theStrengthPresent',
    'tarotcards:the_emperor': 'theEmperorPresent',
    'tarotcards:the_empress': 'theEmpressPresent',
    'tarotcards:the_hermit': 'HermitEffect',
    'tarotcards:wheel_of_fortune': 'wheelOfFortuneEffect',
    'tarotcards:temperance': 'theTemperancePresent',
    'tarotcards:the_tower': 'theTowerPresent',
    'tarotcards:the_moon': 'moonCardEffect',
    'tarotcards:the_sun': 'sunCardEffect',
    'tarotcards:death': 'deathCardEffect',
    'tarotcards:the_magician': 'magicianCardEffect',
    'tarotcards:judgement': 'theJudgmentPresent',
    'tarotcards:the_star': 'starCardEffect',
    'tarotcards:the_world': 'worldCardEffect',
    'tarotcards:justice': 'Justice',
    'tarotcards:the_hierophant' :'TheHierophant',
    'fast:shadow_assassin_cloak': 'shadowAssassinCloakPresent',
    'fast:blaze_necklace': 'FireNecklace',
    'fast:blaze_scroll': 'FireScroll',
    'fast:the_hero_sword': 'HeroSword',
    'fast:magic_shield': 'MagicShield',
    'fast:sword_technique_decisive_strike': 'SwordTechniqueDecisiveStrike',
    'tconstruct:encyclopedia': 'Encyclopedia',
    'fast:the_hero_staff': 'HeroStaff',
    'fast:the_hero_bow': 'HeroBow',
    'fast:the_hero_shield': 'HeroShield',
    'fast:the_hero_card': 'HeroCard',
    'fast:sword_technique_fury_charge': 'SwordTechniqueFuryCharge',
    'fast:sword_technique_four_strike': 'SwordTechniqueFourStrike',
    'fast:ender_necklace': 'EnderNecklace',
    'fast:magic_quiver': 'MagicQuiver',
    'fast:megumin_magic_staff': 'MeguminMagicStaff',
    'fast:frost_staff': 'FrostStaff',
    'fast:shadow_dagge': 'ShadowDagge',
    'fast:iron_heart': 'IronHeart',
    'fast:godspeed_wield': 'GodspeedWield',
    'fast:ice_scroll': 'IceScroll',
    'fast:bule_gem': 'BuleGem',
    'fast:brass_craftsman_hammer': 'BrassCraftsmanHammer',
    'fast:iron_precision_mechanism': 'IronPrecisionMechanism',
    'fast:water_precision_mechanism': 'WaterPrecisionMechanism',
    'touhou_little_maid:fall_protect_bauble': 'FallProtectBauble',
    'fast:ender_scroll': 'EnderScroll',
    'cataclysm:necklace_of_the_desert': 'NecklaceOfTheDesert',
    'cataclysm:abyssal_sacrifice': 'AbyssalSacrifice',
    'cataclysm:burning_ashes': 'IsOnfire',
    'cataclysm:flame_eye': 'FlameEye',
    'cataclysm:void_eye': 'VoidEye',
    'cataclysm:abyss_eye': 'AbyssEye',
    'cataclysm:mech_eye': 'MechEye',
    'cataclysm:monstrous_eye': 'MonstrousEye',
    'cataclysm:cursed_eye': 'CursedEye',
    'cataclysm:desert_eye': 'DesertEye',
    'fast:lethal_shutter': 'LethalShutter',
    'fast:picture_me': 'PictureMe',
    'fast:grimoire_of_mana_reaping': 'GrimoireOfManaReaping',
    'fast:fire_magic_shard': 'FireMagicShard',
    'fast:ice_magic_shard': 'IceMagicShard',
    'fast:nature_magic_shard': 'NatureMagicShard',
    'fast:lightning_magic_shard': 'LightningMagicShard',
    'fast:blood_magic_shard': 'BloodMagicShard',
    'fast:holy_magic_shard': 'HolyMagicShard',
    'fast:ender_magic_shard': 'EnderMagicShard',
    'fast:evocation_magic_shard': 'EvocationMagicShard',
    'fast:blazing_judgement': 'BlazingJudgement',
    'fast:riftsong_edge': 'RiftsongEdge',
    'hmag:fortune_crystal_plus': 'FortuneCrystalPlus',
    'fast:ender_brass_hand': 'EnderBrassHand',
    'fast:shimmering_diamond': 'ShimmeringDiamond',
    'fast:the_card2': 'TheCard2',
    'fast:the_card3': 'TheCard3',
    'fast:apprentice_staff': 'ApprenticeStaff',
    'fast:compassionate_heart': 'CompassionateHeart',
    'fast:shining_beacon': 'ShiningBeacon',
    'celestisynth:celestial_core': 'CelestialCore',
    'fast:ammo_drive': 'AmmoDrive',
    'fast:thunderbrand_magazine': 'ThunderbrandMagazine',
    'fast:precision_pouch': 'PrecisionPouch',
    'fast:justice_staff': 'JusticeStaff',
    'fast:magic_sword': 'MagicSword',
    'fast:berserker_bow': 'BerserkerBow',
    'fast:the_hero_dice': 'HeroDice',
    'cataclysm:storm_eye': 'StormEye',
    'cataclysm:strange_key': 'StrangeKey',
    'fast:blood_pact': 'BloodPact',
    'fast:blood_brand': 'BloodBrand',
    'fast:blood_tally': 'BloodTally',
    'fast:blood_vitality': 'BloodVitality',
    'fast:blood_oath': 'BloodOath',
    'fast:pot_pot': 'PotPot',
    'fast:fate_gem_strength': 'FateGemStrength',
    'fast:fate_gem_agility': 'FateGemAgility',
    'fast:fate_gem_intelligence': 'FateGemIntelligence',
    'fast:fate_gem_vitality': 'FateGemVitality',
    'fast:sword_soul': 'SwordSoul',
    'fast:shadow_chaser': 'ShadowChaser',
    'fast:soul_pact': 'SoulPact',
    'fast:realm_splitter': 'RealmSplitter',
    'fast:spirit_surge': 'SpiritSurge',
    'fast:demon_caller': 'DemonCaller',
    'fast:sword_technique_flying_sword_guard': 'SwordTechniqueFlyingSwordGuard',
};

const ItemBonusMap = {
  'fast:overcharged_mana_flask': { OverchargedManaFlask: 1 },
  'hmag:fortune_crystal': { FortuneCrystal: 1 },
  'fast:primal_fire': { PrimalFire: 1 },
  'fast:blaze_shard': { blazeShardCount: 1 },
  'irons_spellbooks:fire_upgrade_orb': { FireUpgradeOrb: 1 },
  'irons_spellbooks:ice_upgrade_orb': { IceUpgradeOrb: 1 },
  'irons_spellbooks:lightning_upgrade_orb': { LightningUpgradeOrb: 1 },
  'irons_spellbooks:holy_upgrade_orb': { HolyUpgradeOrb: 1 },
  'irons_spellbooks:ender_upgrade_orb': { EnderUpgradeOrb: 1 },
  'irons_spellbooks:blood_upgrade_orb': { BloodUpgradeOrb: 1 },
  'irons_spellbooks:evocation_upgrade_orb': { EvocationUpgradeOrb: 1 },
  'irons_spellbooks:nature_upgrade_orb': { NatureUpgradeOrb: 1 },
  'fast:magic_arrow': { MagicArrow: 1 },
  'fast:charge': { Charge: 1 },
  
  'fast:branch': {
    genericStrBonus: 2,
    genericAgiBonus: 2,
    genericVitBonus: 2,
    genericIntBonus: 2,
  },
  
  'fast:wooden_craftsman_hammer': { genericTecBonus: 2 },
  'fast:iron_craftsman_hammer': { genericTecBonus: 4 },
  'fast:gold_craftsman_hammer': { genericTecBonus: 6 },
  'fast:diamond_craftsman_hammer': { genericTecBonus: 8 },
  'fast:netherite_ingot_craftsman_hammer': { genericTecBonus: 10 },
  
  'fast:iron_ring': { genericStrBonus: 2 },
  'fast:gold_ring': { genericStrBonus: 4 },
  'fast:diamond_ring': { genericStrBonus: 6 },
  
  'hmag:evil_crystal_fragment': { genericAttackBonus: 3 },
  
  'fast:treasure_hoarder': { TreasureHoarder: 1 },
};

let bonusConfig = []

function NewItemBonusOnlyMap(item, key, modifiers) {
    ItemBonusOnlyMap[item] = key
    addEnderBonusAttribute(key, modifiers)
}

function addEnderBonusAttribute(key, modifiers) {
    bonusConfig.push({ key:key, modifiers:modifiers })
}

function registerItemBonusOnlyMap(item, modifiers) {
    let itemName = item.includes(':') ? item.split(':')[1] : item;
    
    let key = itemName
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join('');
    
    ItemBonusOnlyMap[item] = key;
    
    if (modifiers) {
        addEnderBonusAttribute(key, modifiers);
    }
    
}


registerItemBonusOnlyMap("fast:treasure_bait")
registerItemBonusOnlyMap("fast:the_hero_fishing_rod")
registerItemBonusOnlyMap("fast:source_of_venom")
registerItemBonusOnlyMap("fast:justice_shield")
addEnderBonusAttribute('GodspeedWield', [
  { attr: "irons_spellbooks:cast_time_reduction", value: 0.5, op: "multiply_base" },
  { attr: "minecraft:generic.attack_speed", value: 1.5, op: "multiply_base" },
  { attr: "minecraft:generic.movement_speed", value: 1.0, op: "multiply_base" },
])
addEnderBonusAttribute('AbyssalSacrifice', [
  { attr: 'minecraft:generic.max_health', value: -50, op: 'addition' },
  { attr: 'irons_spellbooks:spell_power', value: -0.2, op: 'multiply_base' },
  { attr: 'minecraft:generic.attack_damage', value: -0.2, op: 'multiply_base' }
])
addEnderBonusAttribute('Charge', [
  { attr: "irons_spellbooks:spell_power", value: 0.2, op: "multiply_base" },
  { attr: "irons_spellbooks:mana_regen", value: -0.2, op: "multiply_base" },
])
addEnderBonusAttribute('genericAttackBonus', [
  { attr: "minecraft:generic.attack_damage", value: 1, op: "addition" },
])
addEnderBonusAttribute('genericCritBonus', [
  { attr: "l2damagetracker:crit_rate", value: 0.01, op: "addition" },
])
addEnderBonusAttribute('genericStrBonus', [
  { attr: 'fast:str', value: 1, op: 'addition' },
])
addEnderBonusAttribute('genericIntBonus', [
  { attr: 'fast:int', value: 1, op: 'addition' },
])
addEnderBonusAttribute('genericAgiBonus', [
  { attr: 'fast:agi', value: 1, op: 'addition' },
])
addEnderBonusAttribute('genericVitBonus', [
  { attr: 'fast:vit', value: 1, op: 'addition' },
])
addEnderBonusAttribute('genericTecBonus', [
  { attr: 'fast:tec', value: 1, op: 'addition' },
])
addEnderBonusAttribute('genericAttackSpeedBonus', [
  { attr: 'minecraft:generic.attack_speed', value: 0.01, op: 'multiply_base' },
])
addEnderBonusAttribute('genericMaxHealthBonus', [
  { attr: 'minecraft:generic.max_health', value: 1, op: 'addition' },
])
addEnderBonusAttribute('genericPhysicalMasteryBonus', [
    { attr: 'fast:physical_mastery', value: 0.01, op: 'multiply_base' } 
])
addEnderBonusAttribute('genericSpellPowerBonus', [
    { attr: 'irons_spellbooks:spell_power', value: 0.01, op: 'multiply_base' } 
])
addEnderBonusAttribute('genericEvocationSpellBonus', [
    { attr: 'irons_spellbooks:evocation_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericFireSpellBonus', [
    { attr: 'irons_spellbooks:fire_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericHolySpellBonus', [
    { attr: 'irons_spellbooks:holy_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericEnderSpellBonus', [
    { attr: 'irons_spellbooks:ender_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericLightningSpellBonus', [
    { attr: 'irons_spellbooks:lightning_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericBloodSpellBonus', [
    { attr: 'irons_spellbooks:blood_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericIceSpellBonus', [
    { attr: 'irons_spellbooks:ice_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericNatureSpellBonus', [
    { attr: 'irons_spellbooks:nature_spell_power', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericDefenseBonus', [
    { attr: 'fast:defense', value: 1, op: 'addition' }
])
addEnderBonusAttribute('genericMoveBonus', [
    { attr: 'minecraft:generic.movement_speed', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('genericAttackInvincibleBonus', [
    { attr: 'kubejs:generic.attack_invulnerable_frames', value: 0.01, op: 'multiply_base' }
])
addEnderBonusAttribute('OverchargedManaFlask', [
  { attr: 'minecraft:generic.max_health', value: -0.1, op: 'multiply_base' },
  { attr: 'irons_spellbooks:mana_regen', value: 0.05, op: 'multiply_base' },
  { attr: 'irons_spellbooks:max_mana', value: 500, op: 'addition' },
])
addEnderBonusAttribute('theTemperancePresent', [
  { attr: 'minecraft:generic.attack_damage', value: 1, op: 'multiply_total' },
  { attr: 'kubejs:generic.attack_invulnerable_frames', value: 1, op: 'multiply_base' },
])
addEnderBonusAttribute('theTowerPresent', [
  { attr: 'fast:extra_damage', value: -50, op: 'addition' },
  { attr: 'fast:vit', value: -50, op: 'addition' },
  { attr: 'minecraft:generic.max_health', value: -20, op: 'addition' },
  { attr: 'kubejs:generic.attack_invulnerable_frames', value: 0.1, op: 'multiply_base' },
])
addEnderBonusAttribute('starCardEffect', [
  { attr: 'minecraft:generic.attack_damage', value: 1, op: 'multiply_total' },
])
addEnderBonusAttribute('FireUpgradeOrb', [
  { attr: 'irons_spellbooks:cast_time_reduction', value: -0.1, op: 'multiply_base' },
  { attr: 'irons_spellbooks:fire_spell_power', value: 0.2, op: 'multiply_base' },
])
addEnderBonusAttribute('NatureUpgradeOrb', [
  { attr: 'irons_spellbooks:nature_spell_power', value: 0.2, op: 'multiply_base' },
  { attr: 'minecraft:generic.movement_speed', value: -0.1, op: 'multiply_base' },
])
addEnderBonusAttribute('LightningUpgradeOrb', [
  { attr: 'minecraft:generic.max_health', value: 0.05, op: 'multiply_base' },
  { attr: 'irons_spellbooks:lightning_spell_power', value: 0.1, op: 'multiply_base' },
  { attr: 'fast:defense', value: -0.05, op: 'multiply_base' },
])
addEnderBonusAttribute('EvocationUpgradeOrb', [
  { attr: 'irons_spellbooks:cast_time_reduction', value: 0.1, op: 'multiply_base' },
  { attr: 'irons_spellbooks:evocation_spell_power', value: 0.05, op: 'multiply_base' },
  { attr: 'irons_spellbooks:cooldown_reduction', value: -0.1, op: 'multiply_base' },
])
addEnderBonusAttribute('HolyUpgradeOrb', [
  { attr: 'irons_spellbooks:mana_regen', value: 0.1, op: 'multiply_base' },
  { attr: 'irons_spellbooks:holy_spell_power', value: 0.05, op: 'multiply_base' },
  { attr: 'irons_spellbooks:cooldown_reduction', value: -0.1, op: 'multiply_base' },
])
addEnderBonusAttribute('EnderUpgradeOrb', [
  { attr: 'irons_spellbooks:cooldown_reduction', value: 0.1, op: 'multiply_base' },
  { attr: 'irons_spellbooks:ender_spell_power', value: 0.05, op: 'multiply_base' },
  { attr: 'irons_spellbooks:mana_regen', value: -0.1, op: 'multiply_base' },
])
addEnderBonusAttribute('BloodUpgradeOrb', [
  { attr: 'irons_spellbooks:blood_spell_power', value: 0.15, op: 'multiply_base' },
])
addEnderBonusAttribute('RoseQuartzGauntletsStep', [
  { attr: 'l2damagetracker:crit_rate', value: 0.04, op: 'addition' },
  { attr: 'l2damagetracker:crit_damage', value: 0.1, op: 'addition' },
])
addEnderBonusAttribute('EnderScroll', [
  { attr: 'irons_spellbooks:ender_spell_power', value: 3, op: 'multiply_base' },
])
addEnderBonusAttribute('VoidEye', [
  { attr: 'fast:agi', value: 50, op: 'addition' },
])
addEnderBonusAttribute('AbyssEye', [
  { attr: 'fast:int', value: -100, op: 'addition' },
  { attr: 'irons_spellbooks:max_mana', value: -1000, op: 'addition' },
])
addEnderBonusAttribute('MechEye', [
  { attr: 'l2damagetracker:crit_damage', value: 1, op: 'addition' },
])
addEnderBonusAttribute('DesertEye', [
  { attr: 'kubejs:generic.attack_invulnerable_frames', value: 0.2, op: 'multiply_base' },
])
addEnderBonusAttribute('theHighPriestessPresent', [
  { attr: 'l2damagetracker:crit_rate', value: -0.5, op: 'addition' },
  { attr: 'l2damagetracker:crit_damage', value: 3, op: 'addition' },
])
addEnderBonusAttribute('umaSpeedBonus', [
  { attr: 'minecraft:generic.movement_speed', value: 1, op: 'addition' },
])
addEnderBonusAttribute('theDevilPresent', [
  { attr: 'minecraft:generic.attack_damage', value: -0.6, op: 'multiply_base' },
  { attr: 'minecraft:generic.max_health', value: 0.9, op: 'multiply_base' },
  { attr: 'minecraft:generic.attack_speed', value: -0.1, op: 'addition' },
])
addEnderBonusAttribute('theEmpressPresent', [
  { attr: 'minecraft:generic.max_health', value: 0.5, op: 'multiply_total' },
])
addEnderBonusAttribute('FortuneCrystal', [
  { attr: 'minecraft:generic.luck', value: 1, op: 'addition' },
])
addEnderBonusAttribute('IceMagicShard', [
  { attr: 'irons_spellbooks:ice_spell_power', value: 1, op: 'multiply_base' },
])
addEnderBonusAttribute('blazeShardCount', [
  { 
    attr: 'fast:str', 
    value: 1,
    op: 'addition',
    calculate: (player, enderBonus, multiplier) => {
      if (enderBonus.blazeShardCount && enderBonus.blazeItemCount) {
        return enderBonus.blazeShardCount * enderBonus.blazeItemCount * multiplier
      }
      return 0
    }
  }
])
addEnderBonusAttribute('Encyclopedia', [
  {
    attr: 'minecraft:generic.attack_damage',
    value: 1,
    op: 'addition',
    calculate: (player, enderBonus, multiplier) => {
      if (enderBonus.Encyclopedia && enderBonus.TicAttackDamage) {
        return enderBonus.TicAttackDamage * multiplier
      }
      return 0
    }
  }
])
addEnderBonusAttribute('theChariotPresent', [
  {
    attr: 'l2damagetracker:crit_rate',
    op: 'addition',
    calculate: (player, enderBonus, multiplier) => {
      if (enderBonus.theChariotPresent && enderBonus.mechanicItemCount) {
        return 0.04 * enderBonus.mechanicItemCount * multiplier
      }
      return 0
    }
  }
])
addEnderBonusAttribute('theFoolPresent', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: -6
  },
  {
    attr: 'fast:agi',
    op: 'addition',
    value: -6
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: -6 
  },
  {
    attr: 'fast:vit',
    op: 'addition',
    value: -6 
  }
])
addEnderBonusAttribute('BlazingJudgement', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 10
  }
])
addEnderBonusAttribute('PotPot', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 5 
  }
])
addEnderBonusAttribute('BloodPact', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('BloodBrand', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('BloodTally', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('BloodVitality', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('BloodOath', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('RiftsongEdge', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2 
  }
])
addEnderBonusAttribute('StormEye', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 10
  }
])
addEnderBonusAttribute('StrangeKey', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 15
  }
])
addEnderBonusAttribute('IceScroll', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('JusticeStaff', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 30
  }
])
addEnderBonusAttribute('BerserkerBow', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: -5
  }
])
addEnderBonusAttribute('BuleGem', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 5
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('LethalShutter', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('NecklaceOfTheDesert', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('GrimoireOfManaReaping', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 4
  }
])
addEnderBonusAttribute('HeroDice', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 1
  },
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 1
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: 1
  },
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('FireMagicShard', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 3
  }
])
addEnderBonusAttribute('HolyMagicShard', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 4
  }
])
addEnderBonusAttribute('BloodMagicShard', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('NatureMagicShard', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('LightningMagicShard', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('EvocationMagicShard', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('EnderMagicShard', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('CursedEye', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 10
  }
])
addEnderBonusAttribute('HeroStaff', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 4
  }
])
addEnderBonusAttribute('HeroBow', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('HeroShield', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('HeroSword', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('IsOnfire', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 6
  }
])
addEnderBonusAttribute('FortuneCrystalPlus', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('ThunderbrandMagazine', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 4
  }
])
addEnderBonusAttribute('EnderNecklace', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('CompassionateHeart', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 5
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('magicianCardEffect', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('TheHierophant', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('theEmperorPresent', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 5
  }
])
addEnderBonusAttribute('theStrengthPresent', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('theLoversPresent', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:vit',
    op: 'addition',
    value: 2
  },
  {
    attr: 'fast:int',
    op: 'addition',
    value: 2
  }
])
addEnderBonusAttribute('HermitEffect', [
  {
    attr: 'minecraft:generic.attack_damage',
    op: 'multiply_base',
    value: 0.1
  }
])
addEnderBonusAttribute('FateGemStrength', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: -10
  }
])
addEnderBonusAttribute('FateGemIntelligence', [
  {
    attr: 'fast:int',
    op: 'addition',
    value: -10
  }
])
addEnderBonusAttribute('FateGemVitality', [
  {
    attr: 'fast:vit',
    op: 'addition',
    value: -10
  }
])
addEnderBonusAttribute('FateGemAgility', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: -10
  }
])
addEnderBonusAttribute('SwordSoul', [
  {
    attr: 'fast:str',
    op: 'addition',
    value: 1
  }
])
addEnderBonusAttribute('ShadowChaser', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2  
  }
])
addEnderBonusAttribute('SoulPact', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2  
  }
])
addEnderBonusAttribute('RealmSplitter', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2  
  }
])
addEnderBonusAttribute('SpiritSurge', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2  
  }
])
addEnderBonusAttribute('DemonCaller', [
  {
    attr: 'fast:agi',
    op: 'addition',
    value: 2  
  }
])
NewItemBonusOnlyMap("hmag:evil_crystal", "EvilCrystal", [
  { attr: "minecraft:generic.attack_damage", op: "multiply_base", value: -0.2 },
  { attr: "kubejs:generic.attack_invulnerable_frames", op: "multiply_base", value: -0.2 }
])
NewItemBonusOnlyMap("hmag:soul_powder", "SoulPowder", [
  { attr: "irons_spellbooks:fire_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "irons_spellbooks:ice_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "irons_spellbooks:nature_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "irons_spellbooks:lightning_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "irons_spellbooks:holy_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "irons_spellbooks:ender_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "irons_spellbooks:blood_spell_power", op: "multiply_base", value: 0.15 },
  { attr: "fast:vit", op: "addition", value: -20 }
])
NewItemBonusOnlyMap("hmag:ender_plasm", "EnderPlasm", [
  { attr: "irons_spellbooks:ender_spell_power", op: "multiply_base", value: 1.0 },
  { attr: "fast:int", op: "addition", value: -20 }
])
NewItemBonusOnlyMap("hmag:ancient_stone", "AncientStone", [
  { attr: "fast:str", op: "addition", value: 8 },
  { attr: "fast:agi", op: "addition", value: 8 },
  { attr: "fast:vit", op: "addition", value: -8 },
  { attr: "fast:int", op: "addition", value: -8 }
])
NewItemBonusOnlyMap("hmag:lightning_particle", "LightningParticle", [
  { attr: "irons_spellbooks:lightning_spell_power", op: "multiply_base", value: 0.2 },
  { attr: "fast:vit", op: "addition", value: -10 }
])
NewItemBonusOnlyMap("hmag:insomnia_fruit", "InsomniaFruit", [
  { attr: "irons_spellbooks:evocation_spell_power", op: "multiply_base", value: 0.5 },
  { attr: "fast:agi", op: "addition", value: -10 }
])
NewItemBonusOnlyMap("hmag:insomnia_sword", "InsomniaSword", [
  { attr: "kubejs:generic.attack_invulnerable_frames", op: "multiply_base", value: 0.5 },
  { attr: "fast:str", op: "addition", value: 10 },
  { attr: "fast:vit", op: "addition", value: 10 },
  { attr: "fast:agi", op: "addition", value: -15 },
  { attr: "fast:int", op: "addition", value: -15 }
])
NewItemBonusOnlyMap("hmag:reinforcing_chain", "ReinforcingChain", [
  { attr: "fast:defense", op: "multiply_base", value: 0.5 },
  { attr: "minecraft:generic.max_health", op: "multiply_base", value: -0.5 }
])
NewItemBonusOnlyMap("hmag:purification_cloth", "PurificationCloth", [
  { attr: "irons_spellbooks:holy_spell_power", op: "multiply_base", value: 0.5 },
  { attr: "irons_spellbooks:spell_power", op: "multiply_base", value: -0.1 }
])
NewItemBonusOnlyMap("hmag:endless_pearl", "EndlessPearl", [
  { attr: "irons_spellbooks:ender_spell_power", op: "multiply_base", value: 0.5 },
  { attr: "fast:vit", op: "addition", value: -20 },
  { attr: "fast:agi", op: "addition", value: 10 }
])
NewItemBonusOnlyMap("hmag:fire_bottle", "FireBottle", [
  { attr: "irons_spellbooks:fire_spell_power", op: "multiply_base", value: 0.5 },
  { attr: "fast:vit", op: "addition", value: -5 }
])
NewItemBonusOnlyMap("hmag:greedy_crystal_plus", "GreedyCrystalPlus", [
  { attr: "minecraft:generic.attack_damage", op: "addition", value: 50 },
  { attr: "irons_spellbooks:spell_power", op: "multiply_base", value: 0.2 },
  { attr: "fast:defense", op: "addition", value: -300 },
  { attr: "minecraft:generic.max_health", op: "addition", value: -20 }
])

const QualityItemNeedList = {
'fast:the_hero_card': {},
'fast:the_card1': {r:{max:25, min:1}, sr:{max:50, min:20}, ssr:{max:100, min:40}},
'fast:the_card2': {r:{count:0.33, count2:0.33}, sr:{count:0.66, count2:0.66}, ssr:{count:0.99, count2:0.99}},
'fast:the_card3': {r:{count:0.5, count2:0.7}, sr:{count:1, count2:0.5}, ssr:{count:2, count2:0.3}}
}

const QualityHaveCountItemNeedList = {
'fast:the_card4': {r:{count:1, count2:1}, sr:{count:2, count2:2}, ssr:{count:3, count2:3}, name:'TheCard4'},
'fast:the_card5': {r:{count:0.1, count2:0.1}, sr:{count:0.15, count2:0.07}, ssr:{count:0.2, count2:0.05}, name:'TheCard5'},
'fast:the_card6': {r:{count:2, count2:100}, sr:{count:4, count2:200}, ssr:{count:6, count2:300}, name:'TheCard6'},
'fast:the_card7': {r:{count:2, count2:0.02}, sr:{count:4, count2:0.04}, ssr:{count:6, count2:0.06}, name:'TheCard7'},
'fast:the_card8': {r:{count:3}, sr:{count:4}, ssr:{count:5}, name:'TheCard8'},
'fast:the_card9': {r:{count:0.03}, sr:{count:0.05}, ssr:{count:0.07}, name:'TheCard9'},
'fast:the_card10': {r:{count:0.03}, sr:{count:0.05}, ssr:{count:0.07}, name:'TheCard10'},
'fast:the_card11': {r:{count:0.03}, sr:{count:0.05}, ssr:{count:0.07}, name:'TheCard11'},
'fast:the_card12': {r:{count:0.03}, sr:{count:0.05}, ssr:{count:0.07}, name:'TheCard12'}
}

const genericBonusKeys = [
    'genericStrBonus',
    'genericIntBonus',
    'genericAgiBonus',
    'genericVitBonus',
    'genericTecBonus',
    'genericAttackBonus',
    'genericCritBonus',
    'genericAttackSpeedBonus',
    'genericMaxHealthBonus',
    'genericSpellPowerBonus',
    'genericEvocationSpellBonus',
    'genericFireSpellBonus',
    'genericHolySpellBonus',
    'genericEnderSpellBonus',
    'genericLightningSpellBonus',
    'genericBloodSpellBonus',
    'genericIceSpellBonus',
    'genericNatureSpellBonus',
    'genericDefenseBonus',
    'genericMoveBonus',
    'genericPhysicalMasteryBonus',
    'genericAttackInvincibleBonus',
    'SwordSoulCount',
];


let CustomSpellPlayerData = {}
let PlayerAngerValueData = {}
let PlayerBloodValueData = {}

function updatePlayerEnderBonus(player) {
    if (!player || !player.isAlive()) return;
    let enderChest = player.enderChestInventory;
    let thisPlayerUuid = player.uuid
    let enderBonus = {};
    let MaterialsList = [];
    let genericBonusKeysList = [];
    let PlayerPersistentData = player.persistentData;
    
    PlayerPersistentData.enderBonus = {};
    if (openGuiPlayer[thisPlayerUuid]) {
    PlayerPersistentData.enderBonus.OpenMenuGui = true
    openGuiPlayer[thisPlayerUuid] = false
    }
    
    let persistentData = PlayerPersistentData.enderBonus;
    CustomSpellPlayerData[thisPlayerUuid] = []
    PlayerPersistentData.SwordTechnique = {};
    persistentData.SwordTechniqueList = [];

    if (!PlayerAngerValueData[thisPlayerUuid]) PlayerAngerValueData[thisPlayerUuid] = {}
    let AngerValueData = PlayerAngerValueData[thisPlayerUuid]
    
    if (!PlayerBloodValueData[thisPlayerUuid]) PlayerBloodValueData[thisPlayerUuid] = {}
    
    for (let i = 0; i < enderChest.getContainerSize(); i++) {
        let item = enderChest.getItem(i);
        if (item.isEmpty()) continue;
        let nbt = item.nbt;
        let itemId = String(item.getId());
        if (nbt && nbt.Roguelike) {
        let RogUuid = nbt.Roguelike
        let RogueData = PlayersInRogueLike[player.uuid]
        if (!RoguelikeDungeonManager.hasDungeonByUuid(RogUuid)) continue
        if (!RogueData) continue
        if (RogueData.uuid !== RogUuid) continue
        let PlayerThisLevel = player.level
        if (PlayerThisLevel.dimension !== 'fast:fast_flat_world') continue
        }

        if (ItemBonusOnlyMap.hasOwnProperty(itemId)) {
            if (QualityItemNeedList.hasOwnProperty(itemId)) {
            nbt = item.nbt
            let ItemCardData = nbt.itemcarddata
            let ItemRarity = ItemCardData.rarity;
            if (ItemRarity) {
            let ThisAtt = QualityItemNeedList[itemId][ItemRarity]
            enderBonus[ItemBonusOnlyMap[itemId]] = { rarityAtt: ThisAtt }
            }
            } else {
            enderBonus[ItemBonusOnlyMap[itemId]] = true;
            }
            persistentData[ItemBonusOnlyMap[itemId]] = { i: i };
        }
        
        let Materials = countUniqueHeadMaterials(item);
        if (Materials) {
        let TicAttackDamage = getTicAttackDamage(item);
        if (TicAttackDamage) {
        if (!enderBonus.TicAttackDamage) enderBonus.TicAttackDamage = 0
        enderBonus.TicAttackDamage += TicAttackDamage * 0.5
                }
        }
        
        if (itemId === "fast:the_hero_shield") {
        if (nbt && nbt.close) {
        persistentData[ItemBonusOnlyMap[itemId]] = { i: i , close: true}
        }
        }
        
        if (itemId === "fast:rose_quartz_gauntlets_sequenced_assembly") {
        let Step = getSequencedAssemblyStep(item)
        enderBonus.RoseQuartzGauntletsStep = Step
        enderBonus.RoseQuartzGauntletsTotalSteps = (10 - Step)
        }
        
        if (itemId.includes('sword')) {
        if (!persistentData.HeroSwordAngerValue) {
        persistentData.HeroSwordAngerValue = 0;
        }
        persistentData.HeroSwordAngerValue++
        }
        
        if (typeof item.getItem().performAttack === 'function') {
        persistentData.EnderBrassHandWeapon = itemId
        }
        
        if (nbt) {
        let NbtEnderbonus = nbt.enderbonus;
        if (NbtEnderbonus) {
        if (!NbtEnderbonus.only || !genericBonusKeysList.includes(itemId)) {
        genericBonusKeys.forEach(BonusKey => {
                if (NbtEnderbonus[BonusKey]) {
                    if (!enderBonus[BonusKey]) enderBonus[BonusKey] = 0
                    enderBonus[BonusKey] += NbtEnderbonus[BonusKey];
                    genericBonusKeysList.push(itemId);
                    }
            });
        }
        }
        }

        if (item.hasTag('fast:blaze')) {
        if (!enderBonus.blazeItemCount) enderBonus.blazeItemCount = 0
           enderBonus.blazeItemCount++;
        }

        if (item.hasTag('curios:ring')) {
            enderBonus.ringCount++;
        }
        
        if (item.hasTag('fast:mechanic')) {
        if (!enderBonus.mechanicItemCount) enderBonus.mechanicItemCount = 0
            enderBonus.mechanicItemCount++;
        } else if (checkModifier(item, "kubejs:precision_components")) {
        if (!enderBonus.mechanicItemCount) enderBonus.mechanicItemCount = 0
            enderBonus.mechanicItemCount++;
        }
        
        if (itemId === 'irons_spellbooks:scroll') {
                enderBonus.foundScroll = true; // 找到卷轴，设置标志位
        let nbt = item.getNbt(); // 获取结构化的 NBT 对象
        let spells = nbt?.ISB_Spells?.data; // 获取 ISB_Spells.data 数组
        
        if (spells && Array.isArray(spells)) {
            spells.forEach((spell) => {
                let spellIds = spell.id;
                persistentData.spellIds = spellIds;
                
            })
            }
            }
       
        if (!enderBonus.foundScroll) {
            persistentData.spellIds = [];
        }
        
        if (itemId === 'fast:custom_spell') {
        if (nbt) {
        let thisSepllConfig = nbt.spellConfig
        if (thisSepllConfig) {
        let thisConfig = {
            type: thisSepllConfig.type,
            value: thisSepllConfig.value
        };
        CustomSpellPlayerData[player.uuid].push(thisConfig)
        }
        }
        }
        
    if (itemId === "fast:the_card1") {
    let nbt = item.nbt;
    if (nbt) {
    
    let ItemCardData = nbt.itemcarddata;
    let count = ItemCardData?.count || 0;
    let NeedCount = count * 0.01;
    
    if (!enderBonus.TheCard1) {
        enderBonus.TheCard1 = [];
    }
    
    let ThisAttribute = {};

    if (nbt.weapon) {
    let weaponConfig = nbt.weapon;

    for (const attribute in weaponConfig) {
        if (attribute === 'potential') continue;

        let augmentation = augmentations.find(aug => aug.attribute === attribute);
        if (!augmentation || !augmentation.modifier) continue;

        let value = weaponConfig[attribute] * NeedCount;
        let name = augmentation.modifier.attributeName;
        let operation = augmentation.modifier.operation;
        
        let key = `${name}${operation}`;
        ThisAttribute[key] = { name:name, value:value, operation:operation };
    }
    }
    
    for (let card of enderBonus.TheCard1) {
    for (let key in ThisAttribute) {
        let { name, value, operation } = ThisAttribute[key];
        let existing = card.attribute[name];
        if (existing && existing.operation === operation) {
            existing.value += value;
            delete ThisAttribute[key];
        }
    }
    }
    
    if (Object.keys(ThisAttribute).length > 0) {
    for (let key in ThisAttribute) {
    let { name, value, operation } = ThisAttribute[key];
    let Newattribute = {}
    Newattribute[name] = { value:value, operation:operation }
    enderBonus.TheCard1.push({
        attribute: Newattribute
    });
    }
    }
    
    }
    }
        
        if (QualityHaveCountItemNeedList.hasOwnProperty(itemId)) {
            let ItemCardData = nbt.itemcarddata
            let ItemRarity = ItemCardData.rarity;
            let ThisData = QualityHaveCountItemNeedList[itemId]
            let RarityData = ThisData[ItemRarity]
            let Count = RarityData.count
            let Count2 = RarityData.count2
            let Name = ThisData.name
            if (!enderBonus[Name]) {
            enderBonus[Name] = {}
            enderBonus[Name].count = 0
            enderBonus[Name].count2 = 0
            }
            enderBonus[Name].count += Count
            if (Count2) {
            enderBonus[Name].count2 += Count2
            }
            
        }
        
        let bonus = ItemBonusMap[itemId];
        if (bonus) {
        for (let key in bonus) {
        if (!enderBonus[key]) enderBonus[key] = 0;
        enderBonus[key] += bonus[key];
        }
        }
        
        
    }
    
        // 检测uma_soul物品并累加速度
    if (enderBonus.umaFactorItemPresent) {
    enderBonus.umaSpeedBonus = 0
         for (let i = 0; i < enderChest.getContainerSize(); i++) {
            let item = enderChest.getItem(i);
            if (!item.isEmpty() && String(item.getId()) === 'umapyoi:uma_soul') {
                let nbt = item.getNbtString();
                if(nbt.includes('ranking:"ssr"')){
                   enderBonus.umaSpeedBonus += 0.1;
                }else if(nbt.includes('ranking:"sr"')){
                   enderBonus.umaSpeedBonus += 0.04;
                }else if(nbt.includes('ranking:"r"')){
                    enderBonus.umaSpeedBonus += 0.02;
                }
            }
        }
    }
    applyAllBonuses(player, enderBonus, persistentData, PlayerPersistentData, AngerValueData, enderChest);
}

function applyAllBonuses(player, enderBonus, persistentData, PlayerPersistentData, AngerValueData, enderChest) {

    let multiplier = enderBonus.theHangedManPresent ? -1 : 1;
    
    let MaidList = getPlayerMaidList(player, 40)
    
  const UUID_MAP = {
  addition:      "11111111-1111-1111-1111-111111111111",
  multiply_base: "22222222-2222-2222-2222-222222222222",
  multiply_total:"33333333-3333-3333-3333-333333333333"
  }
    
  let sums = {}
  
  for (let bonus of bonusConfig) {
    let val = enderBonus[bonus.key]
    if (!val) continue
    
    for (let mod of bonus.modifiers) {
      let key = mod.attr + "#" + mod.op
      if (!(key in sums)) sums[key] = 0
      
      if (mod.calculate) {
          sums[key] += mod.calculate(player, enderBonus, multiplier)
        } else if (typeof val === "number") {
        if (val !== 0) {
          sums[key] += mod.value * val * multiplier
        }
      } else {
        sums[key] += mod.value * multiplier
      }
    }
  }
  
  for (let bonus of bonusConfig) {
    for (let mod of bonus.modifiers) {
      let inst = player.getAttribute(mod.attr)
      if (!inst) continue
      inst.removeModifier(UUID.fromString(UUID_MAP[mod.op]))
    }
  }
  
  for (let key in sums) {
    let [attr, op] = key.split("#")
    let inst = player.getAttribute(attr)
    if (!inst) continue

    let modifier = new $AttributeModifier(UUID.fromString(UUID_MAP[op]), `EnderBonus_${op}`, sums[key], op)
    inst.addPermanentModifier(modifier)
  }
    
    HeroCardAttributeEvent(player, persistentData, enderBonus, multiplier)
    
    if (enderBonus.mechanicItemCount) {
    persistentData.mechanicItemCount = enderBonus.mechanicItemCount
    }
    
    player.removeAttribute('irons_spellbooks:max_mana', 'hero_sword');
    player.removeAttribute('minecraft:generic.attack_damage', 'magic_sword');
    player.removeAttribute('irons_spellbooks:spell_power', 'magic_sword');
    
    if (enderBonus.HeroSword) {
    if (!enderBonus.MagicSword) {
        player.modifyAttribute('irons_spellbooks:max_mana', 'hero_sword', -1, 'multiply_total');
    } else {
    if (!enderBonus.theHangedManPresent) {
    player.modifyAttribute('minecraft:generic.attack_damage', 'magic_sword', -0.7, 'multiply_total');
    } else {
    player.modifyAttribute('irons_spellbooks:spell_power', 'magic_sword', -0.7, 'multiply_total');
    }
    }
    if (!AngerValueData.Value) {
       AngerValueData.Open = 0;
       AngerValueData.Value = 0;
        }
       AngerValue(player, persistentData, AngerValueData);
    } else {
       AngerValueData = {};
       AngerValue(player, persistentData, AngerValueData);
    }
    
    if (enderBonus.ApprenticeStaff) {
    player.modifyAttribute('irons_spellbooks:mana_regen', 'ApprenticeStaff', -1, 'multiply_total')
    } else {
    player.removeAttribute('irons_spellbooks:mana_regen', 'ApprenticeStaff');
    }
    
    if (enderBonus.SwordSoul) {
    let level = player.level
    let count = 1
    if (enderBonus.SwordSoulCount) {
    let thiscount = enderBonus.SwordSoulCount
    persistentData.SwordSoulCount = thiscount
    count += thiscount
    }
    let data = persistentData.SwordSoul
    let i = data.i
    let item = enderChest.getItem(i);
    let nbt = item.orCreateTag;
    let swordNBT = nbt.SwordSpirit;
    if (!swordNBT || !swordNBT.item) {
        swordNBT = { item: "minecraft:wooden_sword", count: 1, nbt: {} };
    }
    let swordItemStack = Item.of(swordNBT.item, swordNBT.count, swordNBT.nbt);
        $SpiritSwordEntity.clearSpiritSwords(player)
    for (let j = 0; j < count; j++) {
        let sword = spawnSpiritSwordEntity(level, player, 0.7, 40, 10, swordItemStack)
        
        if (enderBonus.ShadowChaser) {
            sword.setMaxTrackingTime(20);
            sword.setAutoTick(20, true, (s, owner) => {
                if (!s.canLaunch()) return
                if (!owner) return
                if (!s) return
                let pos = owner.position()
                let entity = getNearestEntity(pos, 10, level)
                let swordDamage = 20
                let PlayerPower = owner.getAttribute('irons_spellbooks:spell_power').getValue();
                let HolySpellPower = owner.getAttribute('irons_spellbooks:holy_spell_power').getValue();
                swordDamage *= PlayerPower
                swordDamage *= HolySpellPower
                s.launchAt(entity, swordDamage, NewDamageSource("irons_spellbooks:holy_magic", owner))
            })
        }

        level.addFreshEntity(sword);
    }
    } else {
    $SpiritSwordEntity.clearSpiritSwords(player)
    }
    
    if (enderBonus.ShimmeringDiamond) {
    let data = persistentData.ShimmeringDiamond
    let i = data.i
    let item = enderChest.getItem(i);
    let Value = item.damageValue
    FEValue(player, persistentData, Value)
    } else {
    FEValue(player, persistentData, 0)
    }
    
    if (enderBonus.PrimalFire) {
    persistentData.PrimalFire = enderBonus.PrimalFire
    }
    
    if (enderBonus.TreasureHoarder) {
    persistentData.TreasureHoarder = enderBonus.TreasureHoarder
    }
    
    if (enderBonus.HeroStaff) {
    player.modifyAttribute('forge:entity_reach', 'hero_staff', 12, 'addition');
    } else {
    player.removeAttribute('forge:entity_reach', 'hero_staff');
    }
    
    enderBonus.SwordTechnique = 0
    // 剑技：斩钉截铁
    if (enderBonus.SwordTechniqueDecisiveStrike) {
       persistentData.SwordTechniqueList.push({swordtech:"DecisiveStrike", serail:enderBonus.SwordTechnique});
       enderBonus.SwordTechnique++
    } 
    
    // 剑技：冲锋
    if (enderBonus.SwordTechniqueFuryCharge) {
       persistentData.SwordTechniqueList.push({swordtech:"FuryCharge", serail:enderBonus.SwordTechnique});
       enderBonus.SwordTechnique++
    } 
    
    // 剑技：剑影四连斩
    if (enderBonus.SwordTechniqueFourStrike) {
       persistentData.SwordTechniqueList.push({swordtech:"FourStrike", serail:enderBonus.SwordTechnique});
       enderBonus.SwordTechnique++
    } 
    
    if (enderBonus.SwordTechniqueFlyingSwordGuard) {
       persistentData.SwordTechniqueList.push({swordtech:"FlyingSwordGuard", serail:enderBonus.SwordTechnique});
       enderBonus.SwordTechnique++
    } 
    
    if (enderBonus.SwordTechnique != 0) {
    AngerValueData.SwordTechnique = enderBonus.SwordTechnique;
    }
    
    if (enderBonus.MagicArrow) {
    persistentData.MagicArrow = enderBonus.MagicArrow;
    }
    
    if (enderBonus.BloodMagicShard && enderBonus.HeroSword) {
    persistentData.HeroStaffMagic = "irons_spellbooks:blood_slash"
    }
    
    // 转化属性的效果要最后结算，所有加成效果必须在上面进行，这是分割线------
    
    if (enderBonus.IceUpgradeOrb) {
    let icePower = player.getAttribute('irons_spellbooks:ice_spell_power').getValue();
    player.modifyAttribute('fast:int', 'IceUpgradeOrb', 10 * icePower * enderBonus.IceUpgradeOrb * multiplier, 'addition');
    player.modifyAttribute('irons_spellbooks:max_mana', 'IceUpgradeOrb', -300 * enderBonus.IceUpgradeOrb * multiplier, 'addition');
    } else {
    player.removeAttribute('fast:int', 'IceUpgradeOrb');
    player.removeAttribute('irons_spellbooks:max_mana', 'IceUpgradeOrb');
    }

    
    if (enderBonus.IronPrecisionMechanism) {
    player.modifyAttribute('l2damagetracker:crit_damage', 'iron_precision_mechanism', -0.5, 'multiply_total');
    } else {
    player.removeAttribute('l2damagetracker:crit_damage', 'iron_precision_mechanism');
    }
    
    if (enderBonus.WaterPrecisionMechanism) {
    let Crt = player.getAttribute(`l2damagetracker:crit_rate`).getValue();
    if (Crt) {
    persistentData.WaterPrecisionMechanismCrt = 50 * Crt
    }
    player.modifyAttribute('l2damagetracker:crit_rate', 'water_precision_mechanism', -1, 'multiply_total');
    } else {
    player.removeAttribute('l2damagetracker:crit_rate', 'water_precision_mechanism');
    }
    
    player.removeAttribute('irons_spellbooks:fire_spell_power', 'MeguminMagicStaff');
    player.removeAttribute('irons_spellbooks:cast_time_reduction', 'MeguminMagicStaff');
    player.removeAttribute('irons_spellbooks:cast_time_reduction', 'MeguminMagicStaff_two');
    
    if (enderBonus.MeguminMagicStaff) {
        player.modifyAttribute('irons_spellbooks:fire_spell_power', 'MeguminMagicStaff', 1 * multiplier, 'multiply_total');
        player.modifyAttribute('irons_spellbooks:cast_time_reduction', 'MeguminMagicStaff', -1.5 * multiplier, 'multiply_base');
        let castTime = player.getAttribute('irons_spellbooks:cast_time_reduction').getValue();

        if (castTime < -1) {
        let CastTimeConfig = (castTime + 1)
        player.modifyAttribute('irons_spellbooks:cast_time_reduction', 'MeguminMagicStaff_two', -CastTimeConfig * multiplier, 'multiply_base');
        }
    }
    
    player.removeAttribute('fast:extra_damage', 'strength_bonus');
    player.removeAttribute('minecraft:generic.attack_damage', 'strength_bonus');
    player.removeAttribute('minecraft:generic.max_health', 'strength_bonus');
    player.removeAttribute('irons_spellbooks:max_mana', 'strength_bonus');
    player.removeAttribute('irons_spellbooks:spell_power', 'strength_bonus');
    player.removeAttribute('minecraft:generic.movement_speed', 'strength_speed_penalty');
    
//力量牌加成
    if (enderBonus.theStrengthPresent) {
    if (player.getPersistentData().getBoolean('strengthCardActive') == true) {
        let speed = player.getAttribute('minecraft:generic.movement_speed').getValue();

        if (speed > 0.1) {
            let damageBonus = (speed - 0.1) * 500;
            let speedReductionPercentage = (speed - 0.1) / speed;

            player.modifyAttribute('fast:extra_damage', 'strength_bonus', damageBonus * multiplier * 0.05, 'addition');
            player.modifyAttribute('minecraft:generic.attack_damage', 'strength_bonus', damageBonus * multiplier * 0.5, 'addition');
            player.modifyAttribute('minecraft:generic.max_health', 'strength_bonus', damageBonus * multiplier * 0.02, 'addition');
            player.modifyAttribute('irons_spellbooks:max_mana', 'strength_bonus', damageBonus * multiplier * 0.38 * 1.5, 'addition');
            player.modifyAttribute('irons_spellbooks:spell_power', 'strength_bonus', damageBonus * multiplier * 0.05 * 0.01, 'multiply_base');
            player.modifyAttribute('minecraft:generic.movement_speed', 'strength_speed_penalty', -speedReductionPercentage, 'multiply_total');
        }
      }
    }
    
    player.removeAttribute('irons_spellbooks:lightning_spell_power', 'judgment_lightning');
    player.removeAttribute('minecraft:generic.max_health', 'judgment_health');
    
    if (enderBonus.theJudgmentPresent) {
        // 获取当前总生命值（包含其他加成后的值）
        let maxHealth = player.getAttribute('minecraft:generic.max_health').getValue();
        // 计算加成值（70%生命值转换）
        let lightningPower = maxHealth * 0.7 * 0.01;
        let NeedHp = (maxHealth - 10) / maxHealth

        // 应用闪电法术强度加成
        player.modifyAttribute(
            'irons_spellbooks:lightning_spell_power',
            'judgment_lightning',
            lightningPower,
            'addition'
        );
        
        // 应用最大生命值惩罚
        player.modifyAttribute(
            'minecraft:generic.max_health',
            'judgment_health',
            -NeedHp,
            'multiply_total'
        );
    }
    
     let str = player.getAttribute(`fast:str`).getValue();
     let agi = player.getAttribute(`fast:agi`).getValue();
     let int = player.getAttribute(`fast:int`).getValue();
     let vit = player.getAttribute(`fast:vit`).getValue();
    
// 恋人牌加成
    if (MaidList && enderBonus.theLoversPresent && !enderBonus.FateGemAgility) {
    let PlayerPower = player.getAttribute('irons_spellbooks:spell_power').getValue();
    let FireSpellPower = player.getAttribute('irons_spellbooks:fire_spell_power').getValue();
    let IceSpellPower = player.getAttribute('irons_spellbooks:ice_spell_power').getValue();
    let NatureSpellPower = player.getAttribute('irons_spellbooks:nature_spell_power').getValue();
    let LightningSpellPower = player.getAttribute('irons_spellbooks:lightning_spell_power').getValue();
    let EvocationSpellPower = player.getAttribute('irons_spellbooks:evocation_spell_power').getValue();
    let HolySpellPower = player.getAttribute('irons_spellbooks:holy_spell_power').getValue();
    let EnderSpellPower = player.getAttribute('irons_spellbooks:ender_spell_power').getValue();
    let BloodSpellPower = player.getAttribute('irons_spellbooks:blood_spell_power').getValue();
    let CastTimeReduction = player.getAttribute('irons_spellbooks:cast_time_reduction').getValue();
    let Attack = player.getAttribute('minecraft:generic.attack_damage').getValue();
    let Defense = player.getAttribute('fast:defense').getValue();
    
    MaidList.forEach(maid => {
    let MaidHave = MaidList.length
    let FavoLevel = maid.getFavorabilityManager().getLevel();
    let inheritanceRatio = (FavoLevel + 1) / 4;
    if (MaidHave > 1) {
        inheritanceRatio *= (100 + (MaidHave - 1) * 10) / MaidHave / 100
    }
    
    let GemTypes = [];
    if (MaidItemsUtil.getBaubleSlotInMaid(maid, ItemMaidBaubleStrGem) >= 0) GemTypes.push("str");
    if (MaidItemsUtil.getBaubleSlotInMaid(maid, ItemMaidBaubleAgiGem) >= 0) GemTypes.push("agi");
    if (MaidItemsUtil.getBaubleSlotInMaid(maid, ItemMaidBaubleIntGem) >= 0) GemTypes.push("int");
    if (MaidItemsUtil.getBaubleSlotInMaid(maid, ItemMaidBaubleVitGem) >= 0) GemTypes.push("vit");
    
    let MaidStr = 0;
    let MaidAgi = 0;
    let MaidInt = 0;
    let MaidVit = 0;
    if (GemTypes.length == 0) {
    MaidStr = str;
    MaidAgi = agi;
    MaidInt = int;
    MaidVit = vit;
    } else {
    let AllAttribute = str + agi + int + vit;
    let Average = AllAttribute / GemTypes.length;

    GemTypes.forEach(type => {
        if (type === "str") MaidStr += Average;
        if (type === "agi") MaidAgi += Average;
        if (type === "int") MaidInt += Average;
        if (type === "vit") MaidVit += Average;
    });
    }
    
    if (enderBonus.FateGemStrength) {
    maid.modifyAttribute('minecraft:generic.attack_damage', 'lovers_bonus', (Attack - 1) * inheritanceRatio, 'addition');
    }
    if (enderBonus.FateGemIntelligence) {
    maid.modifyAttribute('irons_spellbooks:spell_power', 'lovers_bonus', (PlayerPower - 1) * inheritanceRatio, 'multiply_base');
    }
    if (enderBonus.FateGemVitality) {
    maid.modifyAttribute('fast:defense', 'lovers_bonus', Defense * inheritanceRatio, 'addition');
    }
    maid.modifyAttribute('irons_spellbooks:cast_time_reduction', 'lovers_bonus', (CastTimeReduction - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:fire_spell_power', 'lovers_bonus', (FireSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:ice_spell_power', 'lovers_bonus', (IceSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:nature_spell_power', 'lovers_bonus', (NatureSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:lightning_spell_power', 'lovers_bonus', (LightningSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:evocation_spell_power', 'lovers_bonus', (EvocationSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:holy_spell_power', 'lovers_bonus', (HolySpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:ender_spell_power', 'lovers_bonus', (EnderSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('irons_spellbooks:blood_spell_power', 'lovers_bonus', (BloodSpellPower - 1) * inheritanceRatio, 'multiply_base');
    maid.modifyAttribute('fast:str', 'lovers_bonus', MaidStr * inheritanceRatio, 'addition');
    maid.modifyAttribute('fast:agi', 'lovers_bonus', MaidAgi * inheritanceRatio, 'addition');
    maid.modifyAttribute('fast:int', 'lovers_bonus', MaidInt * inheritanceRatio, 'addition');
    maid.modifyAttribute('fast:vit', 'lovers_bonus', MaidVit * inheritanceRatio, 'addition');
});
    } else if (MaidList) {
    MaidList.forEach(maid => {
        maid.removeAttribute('irons_spellbooks:spell_power', 'lovers_bonus');
        maid.removeAttribute('fast:defense', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:fire_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:ice_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:nature_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:lightning_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:evocation_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:holy_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:ender_spell_power', 'lovers_bonus');
        maid.removeAttribute('irons_spellbooks:blood_spell_power', 'lovers_bonus');
        maid.removeAttribute('fast:str', 'lovers_bonus');
        maid.removeAttribute('fast:agi', 'lovers_bonus');
        maid.removeAttribute('fast:int', 'lovers_bonus');
        maid.removeAttribute('fast:vit', 'lovers_bonus');
        maid.removeAttribute('minecraft:generic.attack_damage', 'lovers_bonus');
    });
    }
     
    if (enderBonus.FlameEye) {
    player.modifyAttribute('irons_spellbooks:fire_spell_power', 'FlameEye', str * 0.01 * multiplier, 'multiply_base');
    } else {
    player.removeAttribute('irons_spellbooks:fire_spell_power', 'FlameEye');
    }
    
     if (!PlayerPersistentData.theHangedManPresentGet && (str < 0 || agi < 0 || int < 0 || vit < 0)) {
     player.give(Item.of('tarotcards:the_hanged_man',));
     PlayerPersistentData.theHangedManPresentGet = true;
     }
    
     if (MaidList) {
     MaidList.forEach(maid => {
    MaidInvEvent(player, persistentData, maid)
    Rpg(maid, persistentData)
    })
    }
    
    let PlayerHp = player.getHealth();
    let PlayerMaxHp = player.getAttribute('minecraft:generic.max_health').getValue()
    if (PlayerHp > PlayerMaxHp) {
    player.setHealth(PlayerMaxHp);
    }
}

function Rpg(entity, persistentData) {
  let str = entity.getAttribute('fast:str').getValue()
  let agi = entity.getAttribute('fast:agi').getValue()
  let int = entity.getAttribute('fast:int').getValue()
  let vit = entity.getAttribute('fast:vit').getValue()
  
  let thisuuid = "11111111-1111-1111-1111-111111111112"
    let thisuuid2 = "11111111-1111-1111-1111-111111111122"
    let thisuuid3 = "11111111-1111-1111-1111-111111111222"
  
  if (entity.isPlayer() && persistentData.HeroStaff) {
    int *= 1.5
  } else if (!entity.isPlayer()) {
    let HeroStaffBaubleslot = MaidItemsUtil.getBaubleSlotInMaid(entity, ItemMaidBaubleHeroStaff)
    if (HeroStaffBaubleslot >= 0) {
      int *= 1.5
    }
  }
  
  applyModifier(entity, thisuuid, 'minecraft:generic.attack_damage', 'str', str * 0.5, 'addition')
  applyModifier(entity, thisuuid2, 'minecraft:generic.max_health', 'str', str * 0.1, 'addition')
  
  applyModifier(entity, thisuuid, 'irons_spellbooks:spell_power', 'int', int * 0.005, 'addition')
  if (entity.isPlayer() && persistentData.LightningMagicShard) {
    applyModifier(entity, thisuuid3, 'minecraft:generic.max_health', 'int', int * 0.1, 'addition')
  } else if (entity.isPlayer()) {
  removeModifier(entity, thisuuid3, "minecraft:generic.max_health")
  }
  applyModifier(entity, thisuuid, 'irons_spellbooks:max_mana', 'int', int * 1, 'addition')
  
  if (entity.isPlayer() && persistentData.IronHeart) {
    applyModifier(entity, thisuuid2, 'l2damagetracker:crit_rate', 'agi', agi * 0.001, 'addition')
  } else if (entity.isPlayer()) {
  removeModifier(entity, thisuuid2, "l2damagetracker:crit_rate")
  }
  
  if (entity.isPlayer() && persistentData.BrassCraftsmanHammer) {
    let tec = entity.getAttribute('fast:tec').getValue()
    applyModifier(entity, thisuuid, 'l2damagetracker:crit_rate', 'agi', tec * 0.006, 'addition')
  } else if (entity.isPlayer()) {
  removeModifier(entity, thisuuid, "l2damagetracker:crit_rate")
  }
  
  applyModifier(entity, thisuuid, 'minecraft:generic.movement_speed', 'agi', agi * 0.001, 'multiply_base')
  applyModifier(entity, thisuuid, 'minecraft:generic.attack_speed', 'agi', agi * 0.001, 'multiply_base')
  
  if (persistentData.MonstrousEye) {
    applyModifier(entity, thisuuid, 'minecraft:generic.max_health', 'vit', vit * 1, 'addition')
  } else {
    applyModifier(entity, thisuuid, 'minecraft:generic.max_health', 'vit', vit * 0.5, 'addition')
  }
  applyModifier(entity, thisuuid, 'fast:defense', 'vit', vit * 2, 'addition')
}

function HeroCardAttributeEvent(player, persistentData, enderBonus, multiplier) {
        player.removeAttribute('generic.attack_damage', 'the_card1_addition');
       player.removeAttribute('generic.attack_damage', 'the_card1_multiply_base');
        player.removeAttribute('irons_spellbooks:spell_power', 'the_card1_multiply_base');
        player.removeAttribute('fast:int', 'the_card1_addition');
        player.removeAttribute('fast:str', 'the_card1_addition');
        player.removeAttribute('fast:vit', 'the_card1_addition');
        player.removeAttribute('fast:agi', 'the_card1_addition');
        player.removeAttribute('generic.armor', 'the_card1_addition');
        player.removeAttribute('generic.max_health', 'the_card1_addition');
        player.removeAttribute('l2damagetracker:crit_rate', 'the_card1_addition');
        player.removeAttribute('l2damagetracker:crit_damage', 'the_card1_addition');
        player.removeAttribute('fast:defense', 'the_card1_addition');
        player.removeAttribute('minecraft:generic.attack_damage', 'the_card2');
        player.removeAttribute('minecraft:generic.max_health', 'the_card2');
        player.removeAttribute('fast:defense', 'the_card3');
        player.removeAttribute('fast:vit', 'the_card9');
        player.removeAttribute('fast:str', 'the_card10');
        player.removeAttribute('fast:agi', 'the_card11');
        player.removeAttribute('fast:int', 'the_card12');
        player.removeAttribute('fast:str', 'the_card4');
        player.removeAttribute('fast:defense', 'the_card5');
        player.removeAttribute('minecraft:generic.max_health', 'the_card5');
        player.removeAttribute('fast:int', 'the_card6');
        player.removeAttribute('irons_spellbooks:max_mana', 'the_card6');
        player.removeAttribute('fast:agi', 'the_card7');
        player.removeAttribute('irons_spellbooks:evocation_spell_power', 'the_card7');
    if (enderBonus.TheCard1) {
    enderBonus.TheCard1.forEach(card => {
    let attributeData = card.attribute
    for (let attributeName in attributeData) {
        let property = attributeData[attributeName];
        let operation = property.operation.toLowerCase()
        player.modifyAttribute(attributeName, `the_card1_${operation}`, property.value * multiplier, operation);
    }
    });
    }
    if (enderBonus.TheCard2) {
    let data = enderBonus.TheCard2
    let rarityAtt = data.rarityAtt
    let Count = rarityAtt.count
    let Count2 = rarityAtt.count2
    player.modifyAttribute('minecraft:generic.attack_damage', 'the_card2', Count * multiplier, 'multiply_total');
    player.modifyAttribute('minecraft:generic.max_health', 'the_card2', -Count2 * multiplier, 'multiply_total');
    }
    if (enderBonus.TheCard3) {
    let data = enderBonus.TheCard3
    let rarityAtt = data.rarityAtt
    let Count = rarityAtt.count
    let Count2 = rarityAtt.count2
    player.modifyAttribute('fast:defense', 'the_card3', Count * multiplier, 'multiply_total');
    persistentData.TheCard3.Count2 = Count2
    }
    if (enderBonus.TheCard4) {
    let data = enderBonus.TheCard4
    let Count = data.count
    let Count2 = data.count2
    player.modifyAttribute('fast:str', 'the_card4', Count * multiplier, 'addition');
    persistentData.TheCard4 = Count2
    }
    if (enderBonus.TheCard5) {
    let data = enderBonus.TheCard5
    let Count = data.count
    let Count2 = data.count2
    player.modifyAttribute('fast:defense', 'the_card5', Count * multiplier, 'multiply_base');
    player.modifyAttribute('minecraft:generic.max_health', 'the_card5', -Count2 * multiplier, 'multiply_base');
    }
    if (enderBonus.TheCard6) {
    let data = enderBonus.TheCard6
    let Count = data.count
    let Count2 = data.count2
    player.modifyAttribute('fast:int', 'the_card6', Count * multiplier, 'addition');
    player.modifyAttribute('irons_spellbooks:max_mana', 'the_card6', Count2 * multiplier, 'addition');
    }
    if (enderBonus.TheCard7) {
    let data = enderBonus.TheCard7
    let Count = data.count
    let Count2 = data.count2
    player.modifyAttribute('fast:agi', 'the_card7', Count * multiplier, 'addition');
    player.modifyAttribute('irons_spellbooks:evocation_spell_power', 'the_card7', -Count2 * multiplier, 'multiply_base');
    }
    if (enderBonus.TheCard8) {
    let data = enderBonus.TheCard8
    let Count = data.count
    persistentData.TheCard8 = Count
    }
    if (enderBonus.TheCard9) {
    let data = enderBonus.TheCard9
    let Count = data.count
    player.modifyAttribute('fast:vit', 'the_card9', Count * multiplier, 'multiply_base');
    }
    if (enderBonus.TheCard10) {
    let data = enderBonus.TheCard10
    let Count = data.count
    player.modifyAttribute('fast:str', 'the_card10', Count * multiplier, 'multiply_base');
    }
    if (enderBonus.TheCard11) {
    let data = enderBonus.TheCard11
    let Count = data.count
    player.modifyAttribute('fast:agi', 'the_card11', Count * multiplier, 'multiply_base');
    }
    if (enderBonus.TheCard12) {
    let data = enderBonus.TheCard12
    let Count = data.count
    player.modifyAttribute('fast:int', 'the_card12', Count * multiplier, 'multiply_base');
    }
}